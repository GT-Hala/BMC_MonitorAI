import os
import openai
import gradio as gr
import base64
import PyPDF2
from io import BytesIO
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity
from pdf2image import convert_from_bytes
import pytesseract
from dotenv import load_dotenv
import plotly.express as px

load_dotenv()  # ← يقرأ المفاتيح من ملف .env

api_key = os.getenv("SAMBANOVA_API_KEY")  # ← يأخذ المفتاح من البيئة

# ========== إعداد الاتصال بـ SambaNova ========== #
client = openai.OpenAI(
    api_key=os.environ.get("SAMBANOVA_API_KEY"),
    base_url="https://api.sambanova.ai/v1",
)

# ========== تعريف أدوار الشات بوت ========== #
roles_instructions = {
    "المعلم": """🎯 مرحبًا بك في دور المعلم!
أنا هنا لمساعدتك على فهم أساسيات Business Model Canvas (BMC). سأشرح لك المفاهيم بشكل مبسط ومباشر.""",
    "الخبير": """🎯 مرحبًا بك في دور الخبير!
أنا هنا لتقييم نموذج عملك وتقديم توصيات استراتيجية لتحقيق النجاح.""",
    "المحلل": """🎯 مرحبًا بك في دور المحلل!
أنا هنا لتحليل ملفات PDF الخاصة بنموذج العمل الخاص بك.""",
}

# ========== قاعدة بيانات الأسئلة والأجوبة الإستراتيجية ========== #
bmc_knowledge_base = [
    #ما هو Business Model Canvas (BMC)؟
    {
    "السؤال": "ما هو Business Model Canvas (BMC)؟",
    "الإجابة": """🎯 **Business Model Canvas (BMC) هو إطار عمل مرئي يساعدك على تصميم وتحليل نموذج عملك بطريقة واضحة ومنهجية. يوفر BMC تسعة عناصر رئيسية تغطي جميع جوانب نموذج العمل، مما يجعل من السهل فهم واستكشاف كيفية تحقيق القيمة والربحية.

### 📊 مكونات BMC التسع:
1. القيمة المقترحة: ما الذي يقدمه نموذج عملك من منتجات أو خدمات؟
2. شرائح العملاء: من هم عملاؤك المستهدفون؟
3. قنوات التوزيع: كيف ستصل إلى عملائك؟
4. العلاقات مع العملاء: كيف ستبني علاقات قوية مع عملائك؟
5. مصادر الإيرادات: كيف ستجني الأموال؟
6. الموارد الرئيسية: ما الذي تحتاجه لتنفيذ نموذج عملك؟
7. الأنشطة الرئيسية: ما العمليات الأساسية التي يجب تنفيذها يوميًا؟
8. الشراكات الرئيسية: من يمكنه دعم نموذج عملك؟
9. هيكل التكاليف: ما هي التكاليف الرئيسية لتشغيل نموذج العمل؟

💡مثال عملي:
- شركة Airbnb:
  - القيمة المقترحة: توفير أماكن إقامة محلية وفريدة.
  - شرائح العملاء: المسافرون الباحثون عن تجارب محلية.
  - مصادر الإيرادات: عمولات على الحجوزات.
  - الشراكات: التعاون مع أصحاب العقارات."""
},
    # القيمة المقترحة (Value Proposition)
    {
        "السؤال": "ما هي القيمة المقترحة؟",
        "الإجابة": """🌟 القيمة المقترحة هي المنتج أو الخدمة التي تقدمها شركتك وتخلق قيمة حقيقية للعملاء.
- تعريف أعمق: القيمة المقترحة تميزك عن المنافسين وتوضح لماذا يجب على العملاء اختيارك.
- عناصر أساسية:
  - حل مشكلة معينة للعميل.
  - تقديم ميزة تنافسية فريدة.
  - تحسين تجربة العميل بشكل ملموس.
  
💡 مثال عملي:
- شركة Tesla: تقدم سيارات كهربائية عالية الأداء مع تقنيات مستقبلية مثل القيادة الذاتية.
- شركة Netflix: توفر محتوى غير محدود مع توصيات ذكية للمشاهدين."""
    },
    {
        "السؤال": "كيف أجعل القيمة المقترحة جذابة؟",
        "الإجابة": """🚀 لجعل القيمة المقترحة جذابة:
1. ركز على احتياجات العملاء:
   - افهم مشاكلهم الحقيقية.
   - قدم حلولًا مبتكرة لهذه المشاكل.
2. قدم ميزة تنافسية واضحة:
   - السعر: قدم منتجًا بسعر أقل دون فقدان الجودة.
   - الجودة: قدم منتجًا عالي الجودة يتفوق على المنافسين.
   - التجربة: قدم تجربة استخدام فريدة وممتعة.
3. استخدم القصص والأمثلة:
   - استخدم دراسات حالة تبرز كيف ساعدت خدمتك/منتجك العملاء الآخرين.

💡 مثال عملي:
- شركة Airbnb: لم تقدم فقط أماكن للإقامة، بل قدمت تجربة محلية أصيلة للمسافرين."""
    },

    #  شرائح العملاء (Customer Segments)
    {
        "السؤال": "كيف أحدد شرائح العملاء؟",
        "الإجابة": """🎯تحديد شرائح العملاء يتطلب تحليلًا دقيقًا:
1. جمع البيانات:
   - استخدم الاستبيانات والمقابلات.
   - حلل سلوكيات الشراء.
2. تصنيف العملاء:
   - العمر: الفئة العمرية المستهدفة.
   - الدخل: قدرة العملاء على الدفع.
   - الموقع: المناطق الجغرافية المستهدفة.
3. اختبار الفرضيات:
   - قم بتجربة أفكارك على شرائح صغيرة قبل التوسع.

💡 مثال عملي:
- شركة Nike تستهدف:
  - الرياضيين المحترفين.
  - الشباب المهتمين بالموضة.
  - العائلات الباحثة عن أحذية رياضية للأطفال."""
    },
    {
        "السؤال": "كيف أتجنب تشتت الشرائح المستهدفة؟",
        "الإجابة": """⚠️ لتجنب التشتت:
1. حدد أولوية الشريحة الرئيسية:
   - ركز على شريحة واحدة في البداية.
   - قم بتحليل احتياجاتها بشكل عميق.
2. قدم حلولًا مخصصة:
   - قدم منتجات/خدمات تلبي احتياجات هذه الشريحة فقط.
3. توسع تدريجيًا:
   - بعد تحقيق النجاح مع الشريحة الأولى، يمكنك التوسع إلى شرائح جديدة.

💡 مثال عملي:
- شركة Slack بدأت باستهداف فرق البرمجيات الصغيرة، ثم توسعَت لتشمل الشركات الكبيرة."""
    },

    # القنوات (Channels)
    {
        "السؤال": "ما هي أنواع القنوات المتاحة؟",
        "الإجابة": """🔗 أنواع القنوات**:
1. القنوات المباشرة:
   - المتجر الإلكتروني.
   - فريق المبيعات المباشر.
2. القنوات غير المباشرة:
   - تجار التجزئة.
   - السوق الإلكترونية (مثل Amazon).
3. القنوات الرقمية:
   - وسائل التواصل الاجتماعي.
   - الإعلانات الرقمية.

💡 مثال عملي:
- شركة Apple تعتمد على القنوات المباشرة (متاجرها الرسمية) والرقمية (موقعها الإلكتروني)."""
    },
    {
        "السؤال": "كيف أختار القنوات المناسبة؟",
        "الإجابة": """✅ اختيار القنوات المناسبة:
1. حدد مكان تواجد عملائك:
   - إذا كان جمهورك الشباب، استخدم Instagram وSnapchat.
   - إذا كان جمهورك رجال الأعمال، استخدم LinkedIn.
2. قارن التكلفة والعائد:
   - احسب تكلفة الوصول لكل قناة.
   - قارنها بالنتائج المتوقعة.
3. اختبر القنوات المختلفة:
   - جرب أكثر من قناة لمعرفة الأكثر فعالية.

💡 مثال عملي:
- شركة Glossier بدأت بالتسويق عبر Instagram واستخدمته لبناء مجتمع قوي من العملاء."""
    },

    # العلاقات مع العملاء (Customer Relationships)
    {
        "السؤال": "كيف أبني علاقات قوية مع العملاء؟",
        "الإجابة": """🤝 بناء علاقات قوية:
1. وفر دعمًا ممتازًا:
   - استجب للاستفسارات بسرعة.
   - قدم حلولًا فعالة للمشاكل.
2. أنشئ مجتمعات:
   - قم بإنشاء منتديات أو مجموعات على وسائل التواصل.
3. قدم برامج ولاء:
   - قدم نقاطًا أو خصومات للعملاء الدائمين.

💡 مثال عملي:
- شركة Starbucks تقدم بطاقات ولاء تمنح العملاء نقاطًا مقابل كل عملية شراء."""
    },

    #  مصادر الإيرادات (Revenue Streams)
    {
        "السؤال": "ما هي أفضل مصادر الإيرادات للشركات الناشئة؟",
        "الإجابة": """💰 مصادر الإيرادات المناسبة للشركات الناشئة**:
1. :الاشتراكات الشهرية:
   - تدفق نقدي مستقر.
2. المبيعات المباشرة:
   - بيع المنتجات أو الخدمات مباشرة.
3. الرعاية والإعلانات:
   - التعاون مع العلامات التجارية الأخرى.

💡 مثال عملي:
- شركة Spotify تجمع بين الاشتراكات المدفوعة والإعلانات المجانية."""
    },

    #  الموارد الرئيسية (Key Resources)
    {
        "السؤال": "ما هي أهم الموارد الرئيسية للشركات؟",
        "الإجابة": """🔑 أهم الموارد الرئيسية:
1. الموارد البشرية:
   - الموظفون المهرة.
2. الموارد المالية:
   - رأس المال والمصادر الاستثمارية.
3. الموارد المادية:
   - المعدات والمباني.
4. الموارد الفكرية:
   - براءات الاختراع والتراخيص.

💡 مثال عملي:
- شركة Google تعتمد على الموارد البشرية (مهندسين) والفكرية (خوارزميات البحث)."""
    },

    #  الأنشطة الرئيسية (Key Activities)
    {
        "السؤال": "ما هي الأنشطة الرئيسية لأنشطة الشركات؟",
        "الإجابة": """⚡ الأعمال الرئيسية:
1. التصميم والتطوير:
   - تطوير المنتجات أو الخدمات.
2. التسويق والمبيعات:
   - الترويج للمنتجات وجذب العملاء.
3. العمليات والإنتاج:
   - إدارة سلاسل الإمداد والإنتاج.

💡 مثال عملي:
- شركة Tesla تركز على تصميم السيارات وتطوير البطاريات."""
    },

    #  الشراكات الرئيسية (Key Partnerships)
    {
        "السؤال": "كيف أختار الشريك المناسب؟",
        "الإجابة": """🤝 اختيار الشريك المناسب:
1. تأكد من وجود أهداف مشتركة:
   - شريك لديه نفس الرؤية.
2. قيم موثوقيته:
   - تحقق من سجله المهني.
3. تحقق من قدرته على تقديم قيمة مضافة:
   - شريك يقدم موارد أو خدمات تكميلية.

💡 مثال عملي:
- شركة Uber تتعاون مع شركات سيارات لتوسيع أسطولها."""
    },

    # هيكل التكاليف (Cost Structure)
    {
        "السؤال": "كيف أحسب تكاليف تشغيل شركتي؟",
        "الإجابة": """📊 حساب التكاليف:
1. حدد الأنشطة الرئيسية:
   - ما هي العمليات اليومية؟
2. حلل الموارد اللازمة لكل نشاط:
   - الرواتب، المواد الخام، التسويق.
3. جمع النفقات الثابتة والمتغيرة:
   - التكاليف الثابتة: الإيجار، الرواتب.
   - التكاليف المتغيرة: المواد الخام، التوصيل.

💡 مثال عملي:
- شركة توصيل تحتاج إلى تكاليف الوقود والصيانة والرواتب."""
    },

    # كيف أتعامل مع المنافسة في السوق؟
    {
        "السؤال": "كيف أتعامل مع المنافسة في السوق؟",
        "الإجابة": """🏆 للتعامل مع المنافسة:
1. حلل المنافسين:
   - فهم نقاط قوتهم وضعفهم.
2. ركز على التميز:
   - قدم شيئًا لا يستطيع المنافسون تقديمه.
3. ابقَ مرنًا:
   - استجب للتغيرات في السوق بسرعة.

💡 مثال عملي:
- شركة Apple تتميز بالتصميم المبتكر والتكامل بين الأجهزة والبرمجيات."""
    },

    # كيف أطور استراتيجية تسويق فعالة؟
    {
        "السؤال": "كيف أطور استراتيجية تسويق فعالة؟",
        "الإجابة": """🎯 لتطوير استراتيجية تسويق فعالة:
1. حدد الجمهور المستهدف:
   - فهم احتياجاتهم وسلوكياتهم.
2. اختر القنوات المناسبة:
   - استخدم القنوات التي يصل بها جمهورك.
3. قدم رسالة واضحة:
   - اشرح كيف تحل مشكلتهم.

💡 مثال عملي:
- شركة Nike تستخدم التسويق العاطفي لتحفيز الرياضيين."""
    },

    # كيف أضمن استدامة نموذج العمل؟
    {
        "السؤال": "كيف أضمن استدامة نموذج العمل؟",
        "الإجابة": """🌱 لضمان استدامة نموذج العمل:
1. ركز على الابتكار:
   - طور منتجات/خدمات جديدة باستمرار.
2. تحكم في التكاليف:
   - قلل الهدر وزيادة الكفاءة.
3. استمع للعملاء:
   - جدد استراتيجيتك بناءً على ملاحظاتهم.

💡 مثال عملي:
- شركة Tesla تستمر في تطوير تقنيات جديدة للحفاظ على مكانتها التنافسية."""
    },
  #  كيف أطور استراتيجية تسويقية لشركتي؟
    {
        "السؤال": "كيف أطور استراتيجية تسويقية لشركتي؟",
        "الإجابة": """🎯 لتطوير استراتيجية تسويقية ناجحة لشركتك, اتبع الخطوات التالية:

1. حدد الجمهور المستهدف:
   - من هم عملاؤك؟
   - ما هي احتياجاتهم وسلوكياتهم؟

2. اختر القنوات المناسبة:
   - استخدم القنوات التي يصل بها جمهورك المستهدف.
   - على سبيل المثال:
     - Instagram وSnapchat للشباب.
     - LinkedIn لرجال الأعمال.

3. قدم رسالة واضحة:
   - اشرح كيف تحل مشكلتهم.
   - استخدم شعارات بسيطة وجذابة.

4. ابني علاقات قوية:
   - قدم دعمًا ممتازًا.
   - أنشئ مجتمعات تفاعلية.

5. راقب النتائج:
   - استخدم أدوات التحليل لمعرفة أداء الحملات.
   - عدل استراتيجيتك بناءً على النتائج.

💡 مثال عملي:
- شركة Nike تستخدم التسويق العاطفي لتحفيز الرياضيين.
- شركة Glossier بدأت بالتسويق عبر Instagram واستخدمته لبناء مجتمع قوي من العملاء."""
    },

    #  ما هي أفضل طريقة لتحديد شرائح العملاء؟
    {
        "السؤال": "ما هي أفضل طريقة لتحديد شرائح العملاء؟",
        "الإجابة": """🎯 لتحديد شرائح العملاء, اتبع هذه الخطوات:

1. جمع البيانات:
   - استخدم الاستبيانات والمقابلات.
   - حلل سلوكيات الشراء.

2. تصنيف العملاء:
   - العمر: الفئة العمرية المستهدفة.
   - الدخل: قدرة العملاء على الدفع.
   - الموقع: المناطق الجغرافية المستهدفة.

3. اختبار الفرضيات:
   - قم بتجربة أفكارك على شرائح صغيرة قبل التوسع.

4. ركز على الشريحة الرئيسية:
   - حدد أولوية شريحة واحدة في البداية.
   - قدم حلولًا مخصصة لهذه الشريحة.

💡 مثال عملي:
- شركة Nike تستهدف:
  - الرياضيين المحترفين.
  - الشباب المهتمين بالموضة.
  - العائلات الباحثة عن أحذية رياضية للأطفال."""
    },

    #  كيف أختار القنوات المناسبة للتوزيع؟
    {
        "السؤال": "كيف أختار القنوات المناسبة للتوزيع؟",
        "الإجابة": """🔗 للاختيار بين القنوات المناسبة للتوزيع, اتبع هذه الخطوات:

1. حدد مكان تواجد عملائك:
   - إذا كان جمهورك الشباب، استخدم Instagram وSnapchat.
   - إذا كان جمهورك رجال الأعمال، استخدم LinkedIn.

2. قارن التكلفة والعائد:
   - احسب تكلفة الوصول لكل قناة.
   - قارنها بالنتائج المتوقعة.

3. اختبر القنوات المختلفة:
   - جرب أكثر من قناة لمعرفة الأكثر فعالية.

4. اختر القنوات الأكثر فاعلية:
   - استخدم القنوات المباشرة مثل المتجر الإلكتروني.
   - أو القنوات غير المباشرة مثل السوق الإلكترونية (مثل Amazon).

💡 مثال عملي:
- شركة Glossier بدأت بالتسويق عبر Instagram واستخدمته لبناء مجتمع قوي من العملاء.
- شركة Apple تعتمد على القنوات المباشرة (متاجرها الرسمية) والرقمية (موقعها الإلكتروني)."""
    },
   #كيف أبني نموذج عمل ناجح  ؟
{
    "السؤال": "كيف أبني نموذج عمل ناجح ",
    "الإجابة": """🚀 لبناء نموذج عمل ناجح , اتبع الخطوات التالية:

1. ابدأ بتحديد المشكلة:
   - فهم المشاكل التي يواجهها عملاؤك.
   - قدم حلولًا مبتكرة لهذه المشاكل.

2. حدد القيمة المقترحة:
   - كيف تقدم شيئًا فريدًا لا يستطيع المنافسون تقديمه؟

3. حدد شرائح العملاء:
   - ركز على شريحة واحدة في البداية.
   - قدم حلولًا مخصصة لهذه الشريحة.

4. اختر القنوات المناسبة:
   - استخدم القنوات التي يصل بها جمهورك المستهدف.
   - اختبر القنوات المختلفة لمعرفة الأكثر فعالية.

5. ابني علاقات قوية:
   - قدم دعمًا ممتازًا.
   - أنشئ مجتمعات تفاعلية.

6. صمم نموذج الإيرادات:
   - اختر نموذجًا ماليًا مستدامًا (مثل الاشتراكات أو المبيعات المباشرة).

7. حدد الموارد والأنشطة الرئيسية:
   - ما الذي تحتاجه لتشغيل نموذج عملك؟
   - ما العمليات اليومية الأساسية؟

8. ابحث عن شراكات استراتيجية:
   - ابحث عن شركاء يعززون نموذج عملك.

9. تحكم في التكاليف:
   - قلل الهدر وزيادة الكفاءة.

🌟 نصيحة ذهبية:
ركز على تقديم قيمة حقيقية للعملاء، وكن مرنًا لتكييف نموذج عملك بناءً على التغذية الراجعة."""
}
]


# ========== نظام البحث الذكي باستخدام TF-IDF و Cosine Similarity ========== #
def find_in_knowledge_base(user_query, language="ar"):
    user_query = user_query.strip().lower()
    questions = [entry["السؤال"].strip().lower() for entry in bmc_knowledge_base]
    vectorizer = TfidfVectorizer()
    tfidf_matrix = vectorizer.fit_transform(questions + [user_query])
    similarity_scores = cosine_similarity(tfidf_matrix[-1], tfidf_matrix[:-1]).flatten()
    best_match_index = similarity_scores.argmax()
    highest_similarity = similarity_scores[best_match_index]
    if highest_similarity >= 0.4:  # ضبط حد التشابه
        answer = bmc_knowledge_base[best_match_index]["الإجابة"]
        return answer if language == "ar" else translate_to_english(answer)  # دعم اللغات الأخرى
    return None

# ========== ترجمة النصوص إلى الإنجليزية ========== #
def translate_to_english(text):
    try:
        response = client.chat.completions.create(
            model="Meta-Llama-3.3-70B-Instruct",
            messages=[
                {"role": "system", "content": "Translate the following text to English."},
                {"role": "user", "content": text}
            ],
            temperature=0.7,
            max_tokens=1200,
            top_p=0.9
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        return f"⚠️ خطأ في الترجمة: {str(e)}"

# ========== دالة تحليل ملف PDF باستخدام الذكاء الاصطناعي ========== #
def analyze_bmc(file):
    try:
        # التحقق مما إذا كان الملف عبارة عن مسار أو بيانات ثنائية
        if isinstance(file, str):  # إذا كان الملف مسارًا
            if not os.path.exists(file):
                return "❌ خطأ: الملف غير موجود."
            with open(file, "rb") as f:
                pdf_content = f.read()
        else:  # إذا كان الملف بيانات ثنائية مباشرة
            pdf_content = file.read()
        
        # تحليل الملف باستخدام PyPDF2
        pdf_reader = PyPDF2.PdfReader(BytesIO(pdf_content))
        text = "\n".join([page.extract_text() or "" for page in pdf_reader.pages])
        
        # إذا لم يتم العثور على نصوص مباشرة، استخدام OCR
        if not text.strip():
            print("⚠️ لا يوجد نص في الملف... سيتم استخدام OCR")
            images = convert_from_bytes(pdf_content)
            custom_config = r"--oem 3 --psm 6 -l ara"  # تحسين OCR للغة العربية
            text = "\n".join([pytesseract.image_to_string(img, config=custom_config) for img in images])
        
        # إذا لم يتم استخراج أي نص بعد كل المحاولات
        if not text.strip():
            return "❌ خطأ: الملف لا يحتوي على نصوص قابلة للاستخراج (لا نصوص أو OCR فشل)."
        
        # إرسال النص إلى نموذج الذكاء الاصطناعي
        ai_response = generate_ai_response(
            message=f"قم بتقييم هذا النموذج بناءً على محتوى ملف PDF التالي: {text}",
            chat_history=[],
            instruction="""
📌 مهمتك: تحليل نموذج العمل من ملف PDF وإعادة النتائج بالتنسيق التالي:
1. تقييم سريع لكل عنصر من عناصر BMC التسعة:
   - استخدم الرموز: ✅ = موجود وواضح | ⚠️ = بحاجة لتحسين | ❌ = غير موجود.
   - أضف ملاحظة مختصرة لكل عنصر.
   - اقتصر على 3 سطور كحد أقصى لكل عنصر.
   🔹 العناصر:
   - القيمة المقترحة
   - شرائح العملاء
   - قنوات التوزيع
   - العلاقات مع العملاء
   - مصادر الإيرادات
   - الموارد الرئيسية
   - الأنشطة الرئيسية
   - الشراكات الرئيسية
   - هيكل التكاليف
2. تحليل مفصل لكل عنصر:
   - ركز على نقاط القوة والضعف.
   - اذكر مثالًا أو سياقًا واقعيًا لتوضيح التحليل.
   - لا تستخدم أكثر من 4 سطور لكل عنصر.
3. نصائح تحسينية:
   - اقتراح تحسين واحد  ان تطلب ذلك فقط لكل عنصر بعلامة ⚠️ أو ❌.
   - يجب أن تكون النصائح عملية وقابلة للتطبيق.
4. توصيات استراتيجية شاملة:
   - اكتب فقرة واحدة (3-4 سطور) تجمع بين التوصيات الرئيسية.
   - ركز على كيفية تحقيق التوازن بين القيمة، التكاليف، والعائدات.
5. ملاحظات سريعة:
   - لا تضيف أي تحليل خارج نطاق BMC.
   - لا تستخدم جداول أو تنسيقات معقدة.
   - لا تطلب معلومات إضافية.
   - لا تضيف تفسيرات طويلة للرموز ✅/⚠️/❌.
🎯 الهدف: تقديم تحليل محترف وسهل القراءة، مع تمثيل بصري دقيق.
""")
        return ai_response
    except Exception as e:
        return f"❌ خطأ في التحليل: {str(e)}"
# ========== توليد إجابة باستخدام النموذج AI ========== #
def generate_ai_response(message, chat_history, instruction=None):
    try:
        system_instruction = """
🎯 مهمتك هي العمل كمستشار استراتيجي محترف متخصص في Business Model Canvas (BMC)، وتحليل نماذج الأعمال والاستراتيجيات المرتبطة بها.

🚫 لا تجب على أي استفسار خارج نطاق تخصصك (BMC، تحليل نماذج الأعمال، الاستراتيجيات الاقتصادية، تحليل الشركات...). 
إذا ورد سؤال خارج هذا النطاق، استخدم الرد التالي:
"عذرًا، لا يمكنني الإجابة على هذا السؤال لأنه خارج نطاق اختصاصي."

✅ عند استقبال أي سؤال، اتبع التعليمات التالية بدقة:
1. حدّد السياق بدقة من خلال استخراج الكلمات المفتاحية المتعلقة بنموذج العمل.
2. إذا كان السؤال غامضًا أو غير دقيق، أعد صياغته بطريقة واضحة ومهنية قبل تقديم الرد.
3. قدّم إجابة مدروسة ومبنية على أفضل الممارسات الواقعية أو الأطر النظرية المعتمدة في نماذج الأعمال.
4. إذا طلب المستخدم "أعد الشرح" أو "اشرحها لي"، فأعد صياغة الإجابة السابقة بطريقة مبسطة ومناسبة للمستوى العام.
5. إذا طلب المستخدم ترجمة الإجابة السابقة  ترجمها بدقة ، مع الحفاظ على المعنى والاحترافية.
6. اجب بنفس اللغة التي تم طرح بها السؤال 

🎓 تذكير: أنت لا تكتفي بالإجابات النظرية فقط، بل تسعى لتمكين المستخدم من فهم النموذج وتحليله وتطبيقه عمليًا.
"""
        if instruction:
            full_message = f"{instruction}\n\n{message}"
        else:
            full_message = message
            
        messages = [{"role": "system", "content": system_instruction}]
        for msg in chat_history:
            messages.append({"role": msg["role"], "content": msg["content"]})
        
        
        messages.append({"role": "user", "content": full_message})
        
        response = client.chat.completions.create(
            model="Meta-Llama-3.3-70B-Instruct",
            messages=messages,
            temperature=0.7,
            max_tokens=1200,
            top_p=0.9
        )
        bot_message = response.choices[0].message.content.strip()
        return bot_message
    except Exception as e:
        return f"⚠️ حدث خطأ في توليد الإجابة: {str(e)}"

# ========== إنشاء تقرير بصري لنموذج BMC ========== #
def create_bmc_visual_report(ai_response):
    # استخراج البيانات من رد الذكاء الاصطناعي
    labels = []
    values = []
    colors = []

    for line in ai_response.split("\n"):
        if any(symbol in line for symbol in ["✅", "⚠️", "❌"]):
            label, status = line.split(":")
            labels.append(label.strip())
            values.append(status.strip())
            if "✅" in line:
                colors.append("green")
            elif "⚠️" in line:
                colors.append("orange")
            else:
                colors.append("red")

    fig = px.bar(
        x=labels,
        y=[1] * len(labels),  # قيمة ثابتة لكل قسم
        color=values,
        title="📊 تقييم Business Model Canvas",
        labels={"x": "الأقسام", "y": "الحالة"},
        color_discrete_map={
            "موجود": "green",
            "يحتوي على معلومات غير كافية": "orange",
            "غير موجود": "red"
        }
    )
    return fig.to_html()

# ========== CSS مخصص لتحسين الواجهة ========== #
custom_css = """
/* تصميم عام */
body {
    background-color: #f9f9f9;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
.header {
    display: flex;
    align-items: center;
    gap: 25px;
    padding: 15px;
    background: linear-gradient(135deg, #ffffff, #e0f7fa);
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.header img {
    width: 80px;
    height: 80px;
    object-fit: contain;
}
.header h1 {
    margin: 0;
    color: #2d3436;
    font-size: 2rem;
}
.header p {
    margin: 0;
    color: #636e72;
    font-size: 1rem;
}
.bmc-section {
    background: #fff4e6 !important;
    border-radius: 15px !important;
    padding: 20px !important;
    margin-top: 20px !important;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.analysis-result {
    white-space: pre-wrap !important;
    font-family: monospace !important;
    background-color: #f9f9f9;
    padding: 15px;
    border-radius: 10px;
}
button.primary {
    background-color: #00bcd4;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}
button.primary:hover {
    background-color: #0097a7;
}
.footer {
    text-align: center;
    padding: 15px;
    background-color: #2d3436;
    color: white;
    font-size: 0.9rem;
    border-radius: 10px;
    margin-top: 20px;
}
@media (max-width: 768px) {
    .header {
        flex-direction: column;
        padding: 10px;
    }
    .header img {
        width: 60px;
        height: 60px;
    }
    .header h1 {
        font-size: 1.5rem;
    }
    .header p {
        font-size: 0.9rem;
    }
    .chat-container {
        height: 400px !important;
    }
    button.primary {
        font-size: 0.9rem;
    }
}
@media (max-width: 480px) {
    .header h1 {
        font-size: 1.2rem;
    }
    .header p {
        font-size: 0.8rem;
    }
    .chat-container {
        height: 300px !important;
    }
}
"""

# ========== واجهة المستخدم المحسنة ========== #
LOGO_PATH = "F:/BMC MonitorAI.jpg"  # تأكد من صحة المسار
if not os.path.exists(LOGO_PATH):
    raise FileNotFoundError(f"ملف الشعار غير موجود: {LOGO_PATH}")
encoded_logo = base64.b64encode(open(LOGO_PATH, "rb").read()).decode("utf-8")

# رسالة الترحيب التلقائية
WELCOME_MESSAGE = """
✨🔥BMC MonitorAI مرحبًا بك في عالم🔥✨
📈الأفكار تولد هنا💭 والإبداع لا يعرف حدودًا🧠 والنجاح يبدأ بك الآن💡
🚀 اسأل، شارك ملفاتك، وابدأ رحلتك✨   
"""

with gr.Blocks(css=custom_css, theme=gr.themes.Soft(), title="BMC MonitorAI") as demo:
    # ------ شريط العنوان المحسن ------ #
    gr.HTML(f"""
    <div class="header">
        <img src="data:image/png;base64,{encoded_logo}" style="width: 80px; height: 80px; object-fit: contain;">
        <div>
            <h1>BMC MonitorAI</h1>
            <p>المستشار الاستراتيجي الذكي لنماذج الأعمال</p>
        </div>
    </div>
    """)

    
    # ------ منطقة الدردشة المحسنة ------ #
    chatbot = gr.Chatbot(
        avatar_images=(None, LOGO_PATH),
        elem_classes="chat-container",
        show_label=False,
        height=600,
        value=[(None, WELCOME_MESSAGE)]  # إضافة الرسالة الترحيبية هنا
    )

    # ------ عناصر التحكم الذكية ------ #
    with gr.Row():
        msg = gr.Textbox(
            placeholder="💡...للتحليل PDF اكتب سؤالك أو ارفع ملف",
            label=" ",
            scale=8,
            container=False,
            autofocus=True
        )
        submit_btn = gr.Button("إرسال 🚀", variant="primary", scale=2)
        clear_btn = gr.Button("مسح 🔄", variant="secondary")

    # ------ قسم تحليل BMC ------ #
    with gr.Accordion("🔍  (PDF)BMC تحليل ملف ", open=False):
        gr.Markdown("""
        تعليمات الاستخدام:
        1. ارفع ملف PDF يحتوي على نموذج عملك.
        2. انتظر تحليل النموذج .
        3. اقرأ التقييم والنصائح التحسينية.
        """)
        bmc_upload = gr.File(label="📤 رفع الملف", file_types=[".pdf"])
        bmc_output = gr.Textbox(label="نتائج التحليل", elem_classes="analysis-result")
        bmc_visual_report = gr.HTML(label="التقرير البصري")

    # ------ الأسئلة المسبقة ------ #
    gr.Examples(
        examples=[
            "التسعة؟ BMCماهي عناصر",
            "كيف احدد شرائح العملاء؟",
            "اعطني مثالا على نموذج ايرادات مبتكر"
        ],
        inputs=msg,
        label="💼 اسئلة استراتيجية مسبقة"
    )

    # ------ تذييل الصفحة ------ #
    gr.Markdown("""
    <div class="footer">
        ⚡️يدعم تحليل 9 مكونات أساسية<br>
         2025 BMC MonitorAI - جميع الحقوق محفوظة
    </div>
    """)

    # ------ المنطق التشغيلي ------
    chat_history = gr.State([])

    def respond(message, chat_history):
        # البحث عن الإجابة في قاعدة البيانات
        kb_answer = find_in_knowledge_base(message)
        
        if kb_answer:  # إذا تم العثور على إجابة في قاعدة البيانات
            bot_message = kb_answer.strip()
        else:  # استخدام الذكاء الاصطناعي
            bot_message = generate_ai_response(message, chat_history).strip()
            
        # تحديث سجل الدردشة
        chat_history.append({"role": "user", "content": message})
        chat_history.append({"role": "assistant", "content": bot_message})
        
        # تحويل السجل إلى تنسيق العرض
        chat_messages = [
            (msg["content"], None) if msg["role"] == "user" else (None, msg["content"])
            for msg in chat_history
        ]
        return "", chat_messages, chat_history

    msg.submit(respond, [msg, chat_history], [msg, chatbot, chat_history])
    submit_btn.click(respond, [msg, chat_history], [msg, chatbot, chat_history])
    clear_btn.click(lambda: ([], []), [], [chatbot, chat_history])

    # ------ تحليل ملف BMC ------ #
    def analyze_bmc_ui(file):
        if file is None:
            return "❌ خطأ: لم يتم تحميل أي ملف.", ""
        if not file.name.endswith(".pdf"):
            return "❌ خطأ: الملف المرفوع ليس بصيغة PDF.", ""
        # تحليل الملف
        analysis = analyze_bmc(file)
        # إنشاء تقرير بصري
        visual_report = create_bmc_visual_report(analysis)
        return analysis, visual_report

    bmc_upload.upload(analyze_bmc_ui, [bmc_upload], [bmc_output, bmc_visual_report])

# ========== تشغيل التطبيق ========== #
if __name__ == "__main__":
    demo.launch(
        share=True,
        favicon_path=LOGO_PATH if os.path.exists(LOGO_PATH) else None
    )