import os
import openai
import gradio as gr
import base64
import PyPDF2
from io import BytesIO
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity
from pdf2image import convert_from_bytes
import pytesseract
from dotenv import load_dotenv
import plotly.express as px

load_dotenv()  # โ ููุฑุฃ ุงูููุงุชูุญ ูู ููู .env

api_key = os.getenv("SAMBANOVA_API_KEY")  # โ ูุฃุฎุฐ ุงูููุชุงุญ ูู ุงูุจูุฆุฉ

# ========== ุฅุนุฏุงุฏ ุงูุงุชุตุงู ุจู SambaNova ========== #
client = openai.OpenAI(
    api_key=os.environ.get("SAMBANOVA_API_KEY"),
    base_url="https://api.sambanova.ai/v1",
)

# ========== ุชุนุฑูู ุฃุฏูุงุฑ ุงูุดุงุช ุจูุช ========== #
roles_instructions = {
    "ุงููุนูู": """๐ฏ ูุฑุญุจูุง ุจู ูู ุฏูุฑ ุงููุนูู!
ุฃูุง ููุง ููุณุงุนุฏุชู ุนูู ููู ุฃุณุงุณูุงุช Business Model Canvas (BMC). ุณุฃุดุฑุญ ูู ุงูููุงููู ุจุดูู ูุจุณุท ููุจุงุดุฑ.""",
    "ุงูุฎุจูุฑ": """๐ฏ ูุฑุญุจูุง ุจู ูู ุฏูุฑ ุงูุฎุจูุฑ!
ุฃูุง ููุง ูุชูููู ูููุฐุฌ ุนููู ูุชูุฏูู ุชูุตูุงุช ุงุณุชุฑุงุชูุฌูุฉ ูุชุญููู ุงููุฌุงุญ.""",
    "ุงููุญูู": """๐ฏ ูุฑุญุจูุง ุจู ูู ุฏูุฑ ุงููุญูู!
ุฃูุง ููุง ูุชุญููู ูููุงุช PDF ุงูุฎุงุตุฉ ุจูููุฐุฌ ุงูุนูู ุงูุฎุงุต ุจู.""",
}

# ========== ูุงุนุฏุฉ ุจูุงูุงุช ุงูุฃุณุฆูุฉ ูุงูุฃุฌูุจุฉ ุงูุฅุณุชุฑุงุชูุฌูุฉ ========== #
bmc_knowledge_base = [
    #ูุง ูู Business Model Canvas (BMC)ุ
    {
    "ุงูุณุคุงู": "ูุง ูู Business Model Canvas (BMC)ุ",
    "ุงูุฅุฌุงุจุฉ": """๐ฏ **Business Model Canvas (BMC) ูู ุฅุทุงุฑ ุนูู ูุฑุฆู ูุณุงุนุฏู ุนูู ุชุตููู ูุชุญููู ูููุฐุฌ ุนููู ุจุทุฑููุฉ ูุงุถุญุฉ ููููุฌูุฉ. ูููุฑ BMC ุชุณุนุฉ ุนูุงุตุฑ ุฑุฆูุณูุฉ ุชุบุทู ุฌููุน ุฌูุงูุจ ูููุฐุฌ ุงูุนููุ ููุง ูุฌุนู ูู ุงูุณูู ููู ูุงุณุชูุดุงู ููููุฉ ุชุญููู ุงููููุฉ ูุงูุฑุจุญูุฉ.

### ๐ ููููุงุช BMC ุงูุชุณุน:
1. ุงููููุฉ ุงูููุชุฑุญุฉ: ูุง ุงูุฐู ููุฏูู ูููุฐุฌ ุนููู ูู ููุชุฌุงุช ุฃู ุฎุฏูุงุชุ
2. ุดุฑุงุฆุญ ุงูุนููุงุก: ูู ูู ุนููุงุคู ุงููุณุชูุฏูููุ
3. ูููุงุช ุงูุชูุฒูุน: ููู ุณุชุตู ุฅูู ุนููุงุฆูุ
4. ุงูุนูุงูุงุช ูุน ุงูุนููุงุก: ููู ุณุชุจูู ุนูุงูุงุช ูููุฉ ูุน ุนููุงุฆูุ
5. ูุตุงุฏุฑ ุงูุฅูุฑุงุฏุงุช: ููู ุณุชุฌูู ุงูุฃููุงูุ
6. ุงูููุงุฑุฏ ุงูุฑุฆูุณูุฉ: ูุง ุงูุฐู ุชุญุชุงุฌู ูุชูููุฐ ูููุฐุฌ ุนูููุ
7. ุงูุฃูุดุทุฉ ุงูุฑุฆูุณูุฉ: ูุง ุงูุนูููุงุช ุงูุฃุณุงุณูุฉ ุงูุชู ูุฌุจ ุชูููุฐูุง ูููููุงุ
8. ุงูุดุฑุงูุงุช ุงูุฑุฆูุณูุฉ: ูู ููููู ุฏุนู ูููุฐุฌ ุนูููุ
9. ูููู ุงูุชูุงููู: ูุง ูู ุงูุชูุงููู ุงูุฑุฆูุณูุฉ ูุชุดุบูู ูููุฐุฌ ุงูุนููุ

๐กูุซุงู ุนููู:
- ุดุฑูุฉ Airbnb:
  - ุงููููุฉ ุงูููุชุฑุญุฉ: ุชูููุฑ ุฃูุงูู ุฅูุงูุฉ ูุญููุฉ ููุฑูุฏุฉ.
  - ุดุฑุงุฆุญ ุงูุนููุงุก: ุงููุณุงูุฑูู ุงูุจุงุญุซูู ุนู ุชุฌุงุฑุจ ูุญููุฉ.
  - ูุตุงุฏุฑ ุงูุฅูุฑุงุฏุงุช: ุนูููุงุช ุนูู ุงูุญุฌูุฒุงุช.
  - ุงูุดุฑุงูุงุช: ุงูุชุนุงูู ูุน ุฃุตุญุงุจ ุงูุนูุงุฑุงุช."""
},
    # ุงููููุฉ ุงูููุชุฑุญุฉ (Value Proposition)
    {
        "ุงูุณุคุงู": "ูุง ูู ุงููููุฉ ุงูููุชุฑุญุฉุ",
        "ุงูุฅุฌุงุจุฉ": """๐ ุงููููุฉ ุงูููุชุฑุญุฉ ูู ุงูููุชุฌ ุฃู ุงูุฎุฏูุฉ ุงูุชู ุชูุฏููุง ุดุฑูุชู ูุชุฎูู ูููุฉ ุญููููุฉ ููุนููุงุก.
- ุชุนุฑูู ุฃุนูู: ุงููููุฉ ุงูููุชุฑุญุฉ ุชููุฒู ุนู ุงูููุงูุณูู ูุชูุถุญ ููุงุฐุง ูุฌุจ ุนูู ุงูุนููุงุก ุงุฎุชูุงุฑู.
- ุนูุงุตุฑ ุฃุณุงุณูุฉ:
  - ุญู ูุดููุฉ ูุนููุฉ ููุนููู.
  - ุชูุฏูู ููุฒุฉ ุชูุงูุณูุฉ ูุฑูุฏุฉ.
  - ุชุญุณูู ุชุฌุฑุจุฉ ุงูุนููู ุจุดูู ููููุณ.
  
๐ก ูุซุงู ุนููู:
- ุดุฑูุฉ Tesla: ุชูุฏู ุณูุงุฑุงุช ููุฑุจุงุฆูุฉ ุนุงููุฉ ุงูุฃุฏุงุก ูุน ุชูููุงุช ูุณุชูุจููุฉ ูุซู ุงูููุงุฏุฉ ุงูุฐุงุชูุฉ.
- ุดุฑูุฉ Netflix: ุชููุฑ ูุญุชูู ุบูุฑ ูุญุฏูุฏ ูุน ุชูุตูุงุช ุฐููุฉ ูููุดุงูุฏูู."""
    },
    {
        "ุงูุณุคุงู": "ููู ุฃุฌุนู ุงููููุฉ ุงูููุชุฑุญุฉ ุฌุฐุงุจุฉุ",
        "ุงูุฅุฌุงุจุฉ": """๐ ูุฌุนู ุงููููุฉ ุงูููุชุฑุญุฉ ุฌุฐุงุจุฉ:
1. ุฑูุฒ ุนูู ุงุญุชูุงุฌุงุช ุงูุนููุงุก:
   - ุงููู ูุดุงูููู ุงูุญููููุฉ.
   - ูุฏู ุญููููุง ูุจุชูุฑุฉ ููุฐู ุงููุดุงูู.
2. ูุฏู ููุฒุฉ ุชูุงูุณูุฉ ูุงุถุญุฉ:
   - ุงูุณุนุฑ: ูุฏู ููุชุฌูุง ุจุณุนุฑ ุฃูู ุฏูู ููุฏุงู ุงูุฌูุฏุฉ.
   - ุงูุฌูุฏุฉ: ูุฏู ููุชุฌูุง ุนุงูู ุงูุฌูุฏุฉ ูุชููู ุนูู ุงูููุงูุณูู.
   - ุงูุชุฌุฑุจุฉ: ูุฏู ุชุฌุฑุจุฉ ุงุณุชุฎุฏุงู ูุฑูุฏุฉ ูููุชุนุฉ.
3. ุงุณุชุฎุฏู ุงููุตุต ูุงูุฃูุซูุฉ:
   - ุงุณุชุฎุฏู ุฏุฑุงุณุงุช ุญุงูุฉ ุชุจุฑุฒ ููู ุณุงุนุฏุช ุฎุฏูุชู/ููุชุฌู ุงูุนููุงุก ุงูุขุฎุฑูู.

๐ก ูุซุงู ุนููู:
- ุดุฑูุฉ Airbnb: ูู ุชูุฏู ููุท ุฃูุงูู ููุฅูุงูุฉุ ุจู ูุฏูุช ุชุฌุฑุจุฉ ูุญููุฉ ุฃุตููุฉ ูููุณุงูุฑูู."""
    },

    #  ุดุฑุงุฆุญ ุงูุนููุงุก (Customer Segments)
    {
        "ุงูุณุคุงู": "ููู ุฃุญุฏุฏ ุดุฑุงุฆุญ ุงูุนููุงุกุ",
        "ุงูุฅุฌุงุจุฉ": """๐ฏุชุญุฏูุฏ ุดุฑุงุฆุญ ุงูุนููุงุก ูุชุทูุจ ุชุญููููุง ุฏููููุง:
1. ุฌูุน ุงูุจูุงูุงุช:
   - ุงุณุชุฎุฏู ุงูุงุณุชุจูุงูุงุช ูุงูููุงุจูุงุช.
   - ุญูู ุณููููุงุช ุงูุดุฑุงุก.
2. ุชุตููู ุงูุนููุงุก:
   - ุงูุนูุฑ: ุงููุฆุฉ ุงูุนูุฑูุฉ ุงููุณุชูุฏูุฉ.
   - ุงูุฏุฎู: ูุฏุฑุฉ ุงูุนููุงุก ุนูู ุงูุฏูุน.
   - ุงููููุน: ุงูููุงุทู ุงูุฌุบุฑุงููุฉ ุงููุณุชูุฏูุฉ.
3. ุงุฎุชุจุงุฑ ุงููุฑุถูุงุช:
   - ูู ุจุชุฌุฑุจุฉ ุฃููุงุฑู ุนูู ุดุฑุงุฆุญ ุตุบูุฑุฉ ูุจู ุงูุชูุณุน.

๐ก ูุซุงู ุนููู:
- ุดุฑูุฉ Nike ุชุณุชูุฏู:
  - ุงูุฑูุงุถููู ุงููุญุชุฑููู.
  - ุงูุดุจุงุจ ุงูููุชููู ุจุงูููุถุฉ.
  - ุงูุนุงุฆูุงุช ุงูุจุงุญุซุฉ ุนู ุฃุญุฐูุฉ ุฑูุงุถูุฉ ููุฃุทูุงู."""
    },
    {
        "ุงูุณุคุงู": "ููู ุฃุชุฌูุจ ุชุดุชุช ุงูุดุฑุงุฆุญ ุงููุณุชูุฏูุฉุ",
        "ุงูุฅุฌุงุจุฉ": """โ๏ธ ูุชุฌูุจ ุงูุชุดุชุช:
1. ุญุฏุฏ ุฃููููุฉ ุงูุดุฑูุญุฉ ุงูุฑุฆูุณูุฉ:
   - ุฑูุฒ ุนูู ุดุฑูุญุฉ ูุงุญุฏุฉ ูู ุงูุจุฏุงูุฉ.
   - ูู ุจุชุญููู ุงุญุชูุงุฌุงุชูุง ุจุดูู ุนููู.
2. ูุฏู ุญููููุง ูุฎุตุตุฉ:
   - ูุฏู ููุชุฌุงุช/ุฎุฏูุงุช ุชูุจู ุงุญุชูุงุฌุงุช ูุฐู ุงูุดุฑูุญุฉ ููุท.
3. ุชูุณุน ุชุฏุฑูุฌููุง:
   - ุจุนุฏ ุชุญููู ุงููุฌุงุญ ูุน ุงูุดุฑูุญุฉ ุงูุฃูููุ ููููู ุงูุชูุณุน ุฅูู ุดุฑุงุฆุญ ุฌุฏูุฏุฉ.

๐ก ูุซุงู ุนููู:
- ุดุฑูุฉ Slack ุจุฏุฃุช ุจุงุณุชูุฏุงู ูุฑู ุงูุจุฑูุฌูุงุช ุงูุตุบูุฑุฉุ ุซู ุชูุณุนูุช ูุชุดูู ุงูุดุฑูุงุช ุงููุจูุฑุฉ."""
    },

    # ุงููููุงุช (Channels)
    {
        "ุงูุณุคุงู": "ูุง ูู ุฃููุงุน ุงููููุงุช ุงููุชุงุญุฉุ",
        "ุงูุฅุฌุงุจุฉ": """๐ ุฃููุงุน ุงููููุงุช**:
1. ุงููููุงุช ุงููุจุงุดุฑุฉ:
   - ุงููุชุฌุฑ ุงูุฅููุชุฑููู.
   - ูุฑูู ุงููุจูุนุงุช ุงููุจุงุดุฑ.
2. ุงููููุงุช ุบูุฑ ุงููุจุงุดุฑุฉ:
   - ุชุฌุงุฑ ุงูุชุฌุฒุฆุฉ.
   - ุงูุณูู ุงูุฅููุชุฑูููุฉ (ูุซู Amazon).
3. ุงููููุงุช ุงูุฑูููุฉ:
   - ูุณุงุฆู ุงูุชูุงุตู ุงูุงุฌุชูุงุนู.
   - ุงูุฅุนูุงูุงุช ุงูุฑูููุฉ.

๐ก ูุซุงู ุนููู:
- ุดุฑูุฉ Apple ุชุนุชูุฏ ุนูู ุงููููุงุช ุงููุจุงุดุฑุฉ (ูุชุงุฌุฑูุง ุงูุฑุณููุฉ) ูุงูุฑูููุฉ (ูููุนูุง ุงูุฅููุชุฑููู)."""
    },
    {
        "ุงูุณุคุงู": "ููู ุฃุฎุชุงุฑ ุงููููุงุช ุงูููุงุณุจุฉุ",
        "ุงูุฅุฌุงุจุฉ": """โ ุงุฎุชูุงุฑ ุงููููุงุช ุงูููุงุณุจุฉ:
1. ุญุฏุฏ ููุงู ุชูุงุฌุฏ ุนููุงุฆู:
   - ุฅุฐุง ูุงู ุฌูููุฑู ุงูุดุจุงุจุ ุงุณุชุฎุฏู Instagram ูSnapchat.
   - ุฅุฐุง ูุงู ุฌูููุฑู ุฑุฌุงู ุงูุฃุนูุงูุ ุงุณุชุฎุฏู LinkedIn.
2. ูุงุฑู ุงูุชูููุฉ ูุงูุนุงุฆุฏ:
   - ุงุญุณุจ ุชูููุฉ ุงููุตูู ููู ููุงุฉ.
   - ูุงุฑููุง ุจุงููุชุงุฆุฌ ุงููุชููุนุฉ.
3. ุงุฎุชุจุฑ ุงููููุงุช ุงููุฎุชููุฉ:
   - ุฌุฑุจ ุฃูุซุฑ ูู ููุงุฉ ููุนุฑูุฉ ุงูุฃูุซุฑ ูุนุงููุฉ.

๐ก ูุซุงู ุนููู:
- ุดุฑูุฉ Glossier ุจุฏุฃุช ุจุงูุชุณููู ุนุจุฑ Instagram ูุงุณุชุฎุฏูุชู ูุจูุงุก ูุฌุชูุน ููู ูู ุงูุนููุงุก."""
    },

    # ุงูุนูุงูุงุช ูุน ุงูุนููุงุก (Customer Relationships)
    {
        "ุงูุณุคุงู": "ููู ุฃุจูู ุนูุงูุงุช ูููุฉ ูุน ุงูุนููุงุกุ",
        "ุงูุฅุฌุงุจุฉ": """๐ค ุจูุงุก ุนูุงูุงุช ูููุฉ:
1. ููุฑ ุฏุนููุง ููุชุงุฒูุง:
   - ุงุณุชุฌุจ ููุงุณุชูุณุงุฑุงุช ุจุณุฑุนุฉ.
   - ูุฏู ุญููููุง ูุนุงูุฉ ูููุดุงูู.
2. ุฃูุดุฆ ูุฌุชูุนุงุช:
   - ูู ุจุฅูุดุงุก ููุชุฏูุงุช ุฃู ูุฌููุนุงุช ุนูู ูุณุงุฆู ุงูุชูุงุตู.
3. ูุฏู ุจุฑุงูุฌ ููุงุก:
   - ูุฏู ููุงุทูุง ุฃู ุฎุตููุงุช ููุนููุงุก ุงูุฏุงุฆููู.

๐ก ูุซุงู ุนููู:
- ุดุฑูุฉ Starbucks ุชูุฏู ุจุทุงูุงุช ููุงุก ุชููุญ ุงูุนููุงุก ููุงุทูุง ููุงุจู ูู ุนูููุฉ ุดุฑุงุก."""
    },

    #  ูุตุงุฏุฑ ุงูุฅูุฑุงุฏุงุช (Revenue Streams)
    {
        "ุงูุณุคุงู": "ูุง ูู ุฃูุถู ูุตุงุฏุฑ ุงูุฅูุฑุงุฏุงุช ููุดุฑูุงุช ุงููุงุดุฆุฉุ",
        "ุงูุฅุฌุงุจุฉ": """๐ฐ ูุตุงุฏุฑ ุงูุฅูุฑุงุฏุงุช ุงูููุงุณุจุฉ ููุดุฑูุงุช ุงููุงุดุฆุฉ**:
1. :ุงูุงุดุชุฑุงูุงุช ุงูุดูุฑูุฉ:
   - ุชุฏูู ููุฏู ูุณุชูุฑ.
2. ุงููุจูุนุงุช ุงููุจุงุดุฑุฉ:
   - ุจูุน ุงูููุชุฌุงุช ุฃู ุงูุฎุฏูุงุช ูุจุงุดุฑุฉ.
3. ุงูุฑุนุงูุฉ ูุงูุฅุนูุงูุงุช:
   - ุงูุชุนุงูู ูุน ุงูุนูุงูุงุช ุงูุชุฌุงุฑูุฉ ุงูุฃุฎุฑู.

๐ก ูุซุงู ุนููู:
- ุดุฑูุฉ Spotify ุชุฌูุน ุจูู ุงูุงุดุชุฑุงูุงุช ุงููุฏููุนุฉ ูุงูุฅุนูุงูุงุช ุงููุฌุงููุฉ."""
    },

    #  ุงูููุงุฑุฏ ุงูุฑุฆูุณูุฉ (Key Resources)
    {
        "ุงูุณุคุงู": "ูุง ูู ุฃูู ุงูููุงุฑุฏ ุงูุฑุฆูุณูุฉ ููุดุฑูุงุชุ",
        "ุงูุฅุฌุงุจุฉ": """๐ ุฃูู ุงูููุงุฑุฏ ุงูุฑุฆูุณูุฉ:
1. ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ:
   - ุงูููุธููู ุงูููุฑุฉ.
2. ุงูููุงุฑุฏ ุงููุงููุฉ:
   - ุฑุฃุณ ุงููุงู ูุงููุตุงุฏุฑ ุงูุงุณุชุซูุงุฑูุฉ.
3. ุงูููุงุฑุฏ ุงููุงุฏูุฉ:
   - ุงููุนุฏุงุช ูุงููุจุงูู.
4. ุงูููุงุฑุฏ ุงูููุฑูุฉ:
   - ุจุฑุงุกุงุช ุงูุงุฎุชุฑุงุน ูุงูุชุฑุงุฎูุต.

๐ก ูุซุงู ุนููู:
- ุดุฑูุฉ Google ุชุนุชูุฏ ุนูู ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ (ูููุฏุณูู) ูุงูููุฑูุฉ (ุฎูุงุฑุฒููุงุช ุงูุจุญุซ)."""
    },

    #  ุงูุฃูุดุทุฉ ุงูุฑุฆูุณูุฉ (Key Activities)
    {
        "ุงูุณุคุงู": "ูุง ูู ุงูุฃูุดุทุฉ ุงูุฑุฆูุณูุฉ ูุฃูุดุทุฉ ุงูุดุฑูุงุชุ",
        "ุงูุฅุฌุงุจุฉ": """โก ุงูุฃุนูุงู ุงูุฑุฆูุณูุฉ:
1. ุงูุชุตููู ูุงูุชุทููุฑ:
   - ุชุทููุฑ ุงูููุชุฌุงุช ุฃู ุงูุฎุฏูุงุช.
2. ุงูุชุณููู ูุงููุจูุนุงุช:
   - ุงูุชุฑููุฌ ููููุชุฌุงุช ูุฌุฐุจ ุงูุนููุงุก.
3. ุงูุนูููุงุช ูุงูุฅูุชุงุฌ:
   - ุฅุฏุงุฑุฉ ุณูุงุณู ุงูุฅูุฏุงุฏ ูุงูุฅูุชุงุฌ.

๐ก ูุซุงู ุนููู:
- ุดุฑูุฉ Tesla ุชุฑูุฒ ุนูู ุชุตููู ุงูุณูุงุฑุงุช ูุชุทููุฑ ุงูุจุทุงุฑูุงุช."""
    },

    #  ุงูุดุฑุงูุงุช ุงูุฑุฆูุณูุฉ (Key Partnerships)
    {
        "ุงูุณุคุงู": "ููู ุฃุฎุชุงุฑ ุงูุดุฑูู ุงูููุงุณุจุ",
        "ุงูุฅุฌุงุจุฉ": """๐ค ุงุฎุชูุงุฑ ุงูุดุฑูู ุงูููุงุณุจ:
1. ุชุฃูุฏ ูู ูุฌูุฏ ุฃูุฏุงู ูุดุชุฑูุฉ:
   - ุดุฑูู ูุฏูู ููุณ ุงูุฑุคูุฉ.
2. ููู ููุซูููุชู:
   - ุชุญูู ูู ุณุฌูู ุงููููู.
3. ุชุญูู ูู ูุฏุฑุชู ุนูู ุชูุฏูู ูููุฉ ูุถุงูุฉ:
   - ุดุฑูู ููุฏู ููุงุฑุฏ ุฃู ุฎุฏูุงุช ุชูููููุฉ.

๐ก ูุซุงู ุนููู:
- ุดุฑูุฉ Uber ุชุชุนุงูู ูุน ุดุฑูุงุช ุณูุงุฑุงุช ูุชูุณูุน ุฃุณุทูููุง."""
    },

    # ูููู ุงูุชูุงููู (Cost Structure)
    {
        "ุงูุณุคุงู": "ููู ุฃุญุณุจ ุชูุงููู ุชุดุบูู ุดุฑูุชูุ",
        "ุงูุฅุฌุงุจุฉ": """๐ ุญุณุงุจ ุงูุชูุงููู:
1. ุญุฏุฏ ุงูุฃูุดุทุฉ ุงูุฑุฆูุณูุฉ:
   - ูุง ูู ุงูุนูููุงุช ุงูููููุฉุ
2. ุญูู ุงูููุงุฑุฏ ุงููุงุฒูุฉ ููู ูุดุงุท:
   - ุงูุฑูุงุชุจุ ุงูููุงุฏ ุงูุฎุงูุ ุงูุชุณููู.
3. ุฌูุน ุงููููุงุช ุงูุซุงุจุชุฉ ูุงููุชุบูุฑุฉ:
   - ุงูุชูุงููู ุงูุซุงุจุชุฉ: ุงูุฅูุฌุงุฑุ ุงูุฑูุงุชุจ.
   - ุงูุชูุงููู ุงููุชุบูุฑุฉ: ุงูููุงุฏ ุงูุฎุงูุ ุงูุชูุตูู.

๐ก ูุซุงู ุนููู:
- ุดุฑูุฉ ุชูุตูู ุชุญุชุงุฌ ุฅูู ุชูุงููู ุงููููุฏ ูุงูุตูุงูุฉ ูุงูุฑูุงุชุจ."""
    },

    # ููู ุฃุชุนุงูู ูุน ุงูููุงูุณุฉ ูู ุงูุณููุ
    {
        "ุงูุณุคุงู": "ููู ุฃุชุนุงูู ูุน ุงูููุงูุณุฉ ูู ุงูุณููุ",
        "ุงูุฅุฌุงุจุฉ": """๐ ููุชุนุงูู ูุน ุงูููุงูุณุฉ:
1. ุญูู ุงูููุงูุณูู:
   - ููู ููุงุท ููุชูู ูุถุนููู.
2. ุฑูุฒ ุนูู ุงูุชููุฒ:
   - ูุฏู ุดูุฆูุง ูุง ูุณุชุทูุน ุงูููุงูุณูู ุชูุฏููู.
3. ุงุจูู ูุฑููุง:
   - ุงุณุชุฌุจ ููุชุบูุฑุงุช ูู ุงูุณูู ุจุณุฑุนุฉ.

๐ก ูุซุงู ุนููู:
- ุดุฑูุฉ Apple ุชุชููุฒ ุจุงูุชุตููู ุงููุจุชูุฑ ูุงูุชูุงูู ุจูู ุงูุฃุฌูุฒุฉ ูุงูุจุฑูุฌูุงุช."""
    },

    # ููู ุฃุทูุฑ ุงุณุชุฑุงุชูุฌูุฉ ุชุณููู ูุนุงูุฉุ
    {
        "ุงูุณุคุงู": "ููู ุฃุทูุฑ ุงุณุชุฑุงุชูุฌูุฉ ุชุณููู ูุนุงูุฉุ",
        "ุงูุฅุฌุงุจุฉ": """๐ฏ ูุชุทููุฑ ุงุณุชุฑุงุชูุฌูุฉ ุชุณููู ูุนุงูุฉ:
1. ุญุฏุฏ ุงูุฌูููุฑ ุงููุณุชูุฏู:
   - ููู ุงุญุชูุงุฌุงุชูู ูุณููููุงุชูู.
2. ุงุฎุชุฑ ุงููููุงุช ุงูููุงุณุจุฉ:
   - ุงุณุชุฎุฏู ุงููููุงุช ุงูุชู ูุตู ุจูุง ุฌูููุฑู.
3. ูุฏู ุฑุณุงูุฉ ูุงุถุญุฉ:
   - ุงุดุฑุญ ููู ุชุญู ูุดููุชูู.

๐ก ูุซุงู ุนููู:
- ุดุฑูุฉ Nike ุชุณุชุฎุฏู ุงูุชุณููู ุงูุนุงุทูู ูุชุญููุฒ ุงูุฑูุงุถููู."""
    },

    # ููู ุฃุถูู ุงุณุชุฏุงูุฉ ูููุฐุฌ ุงูุนููุ
    {
        "ุงูุณุคุงู": "ููู ุฃุถูู ุงุณุชุฏุงูุฉ ูููุฐุฌ ุงูุนููุ",
        "ุงูุฅุฌุงุจุฉ": """๐ฑ ูุถูุงู ุงุณุชุฏุงูุฉ ูููุฐุฌ ุงูุนูู:
1. ุฑูุฒ ุนูู ุงูุงุจุชูุงุฑ:
   - ุทูุฑ ููุชุฌุงุช/ุฎุฏูุงุช ุฌุฏูุฏุฉ ุจุงุณุชูุฑุงุฑ.
2. ุชุญูู ูู ุงูุชูุงููู:
   - ููู ุงููุฏุฑ ูุฒูุงุฏุฉ ุงูููุงุกุฉ.
3. ุงุณุชูุน ููุนููุงุก:
   - ุฌุฏุฏ ุงุณุชุฑุงุชูุฌูุชู ุจูุงุกู ุนูู ููุงุญุธุงุชูู.

๐ก ูุซุงู ุนููู:
- ุดุฑูุฉ Tesla ุชุณุชูุฑ ูู ุชุทููุฑ ุชูููุงุช ุฌุฏูุฏุฉ ููุญูุงุธ ุนูู ููุงูุชูุง ุงูุชูุงูุณูุฉ."""
    },
  #  ููู ุฃุทูุฑ ุงุณุชุฑุงุชูุฌูุฉ ุชุณููููุฉ ูุดุฑูุชูุ
    {
        "ุงูุณุคุงู": "ููู ุฃุทูุฑ ุงุณุชุฑุงุชูุฌูุฉ ุชุณููููุฉ ูุดุฑูุชูุ",
        "ุงูุฅุฌุงุจุฉ": """๐ฏ ูุชุทููุฑ ุงุณุชุฑุงุชูุฌูุฉ ุชุณููููุฉ ูุงุฌุญุฉ ูุดุฑูุชู, ุงุชุจุน ุงูุฎุทูุงุช ุงูุชุงููุฉ:

1. ุญุฏุฏ ุงูุฌูููุฑ ุงููุณุชูุฏู:
   - ูู ูู ุนููุงุคูุ
   - ูุง ูู ุงุญุชูุงุฌุงุชูู ูุณููููุงุชููุ

2. ุงุฎุชุฑ ุงููููุงุช ุงูููุงุณุจุฉ:
   - ุงุณุชุฎุฏู ุงููููุงุช ุงูุชู ูุตู ุจูุง ุฌูููุฑู ุงููุณุชูุฏู.
   - ุนูู ุณุจูู ุงููุซุงู:
     - Instagram ูSnapchat ููุดุจุงุจ.
     - LinkedIn ูุฑุฌุงู ุงูุฃุนูุงู.

3. ูุฏู ุฑุณุงูุฉ ูุงุถุญุฉ:
   - ุงุดุฑุญ ููู ุชุญู ูุดููุชูู.
   - ุงุณุชุฎุฏู ุดุนุงุฑุงุช ุจุณูุทุฉ ูุฌุฐุงุจุฉ.

4. ุงุจูู ุนูุงูุงุช ูููุฉ:
   - ูุฏู ุฏุนููุง ููุชุงุฒูุง.
   - ุฃูุดุฆ ูุฌุชูุนุงุช ุชูุงุนููุฉ.

5. ุฑุงูุจ ุงููุชุงุฆุฌ:
   - ุงุณุชุฎุฏู ุฃุฏูุงุช ุงูุชุญููู ููุนุฑูุฉ ุฃุฏุงุก ุงูุญููุงุช.
   - ุนุฏู ุงุณุชุฑุงุชูุฌูุชู ุจูุงุกู ุนูู ุงููุชุงุฆุฌ.

๐ก ูุซุงู ุนููู:
- ุดุฑูุฉ Nike ุชุณุชุฎุฏู ุงูุชุณููู ุงูุนุงุทูู ูุชุญููุฒ ุงูุฑูุงุถููู.
- ุดุฑูุฉ Glossier ุจุฏุฃุช ุจุงูุชุณููู ุนุจุฑ Instagram ูุงุณุชุฎุฏูุชู ูุจูุงุก ูุฌุชูุน ููู ูู ุงูุนููุงุก."""
    },

    #  ูุง ูู ุฃูุถู ุทุฑููุฉ ูุชุญุฏูุฏ ุดุฑุงุฆุญ ุงูุนููุงุกุ
    {
        "ุงูุณุคุงู": "ูุง ูู ุฃูุถู ุทุฑููุฉ ูุชุญุฏูุฏ ุดุฑุงุฆุญ ุงูุนููุงุกุ",
        "ุงูุฅุฌุงุจุฉ": """๐ฏ ูุชุญุฏูุฏ ุดุฑุงุฆุญ ุงูุนููุงุก, ุงุชุจุน ูุฐู ุงูุฎุทูุงุช:

1. ุฌูุน ุงูุจูุงูุงุช:
   - ุงุณุชุฎุฏู ุงูุงุณุชุจูุงูุงุช ูุงูููุงุจูุงุช.
   - ุญูู ุณููููุงุช ุงูุดุฑุงุก.

2. ุชุตููู ุงูุนููุงุก:
   - ุงูุนูุฑ: ุงููุฆุฉ ุงูุนูุฑูุฉ ุงููุณุชูุฏูุฉ.
   - ุงูุฏุฎู: ูุฏุฑุฉ ุงูุนููุงุก ุนูู ุงูุฏูุน.
   - ุงููููุน: ุงูููุงุทู ุงูุฌุบุฑุงููุฉ ุงููุณุชูุฏูุฉ.

3. ุงุฎุชุจุงุฑ ุงููุฑุถูุงุช:
   - ูู ุจุชุฌุฑุจุฉ ุฃููุงุฑู ุนูู ุดุฑุงุฆุญ ุตุบูุฑุฉ ูุจู ุงูุชูุณุน.

4. ุฑูุฒ ุนูู ุงูุดุฑูุญุฉ ุงูุฑุฆูุณูุฉ:
   - ุญุฏุฏ ุฃููููุฉ ุดุฑูุญุฉ ูุงุญุฏุฉ ูู ุงูุจุฏุงูุฉ.
   - ูุฏู ุญููููุง ูุฎุตุตุฉ ููุฐู ุงูุดุฑูุญุฉ.

๐ก ูุซุงู ุนููู:
- ุดุฑูุฉ Nike ุชุณุชูุฏู:
  - ุงูุฑูุงุถููู ุงููุญุชุฑููู.
  - ุงูุดุจุงุจ ุงูููุชููู ุจุงูููุถุฉ.
  - ุงูุนุงุฆูุงุช ุงูุจุงุญุซุฉ ุนู ุฃุญุฐูุฉ ุฑูุงุถูุฉ ููุฃุทูุงู."""
    },

    #  ููู ุฃุฎุชุงุฑ ุงููููุงุช ุงูููุงุณุจุฉ ููุชูุฒูุนุ
    {
        "ุงูุณุคุงู": "ููู ุฃุฎุชุงุฑ ุงููููุงุช ุงูููุงุณุจุฉ ููุชูุฒูุนุ",
        "ุงูุฅุฌุงุจุฉ": """๐ ููุงุฎุชูุงุฑ ุจูู ุงููููุงุช ุงูููุงุณุจุฉ ููุชูุฒูุน, ุงุชุจุน ูุฐู ุงูุฎุทูุงุช:

1. ุญุฏุฏ ููุงู ุชูุงุฌุฏ ุนููุงุฆู:
   - ุฅุฐุง ูุงู ุฌูููุฑู ุงูุดุจุงุจุ ุงุณุชุฎุฏู Instagram ูSnapchat.
   - ุฅุฐุง ูุงู ุฌูููุฑู ุฑุฌุงู ุงูุฃุนูุงูุ ุงุณุชุฎุฏู LinkedIn.

2. ูุงุฑู ุงูุชูููุฉ ูุงูุนุงุฆุฏ:
   - ุงุญุณุจ ุชูููุฉ ุงููุตูู ููู ููุงุฉ.
   - ูุงุฑููุง ุจุงููุชุงุฆุฌ ุงููุชููุนุฉ.

3. ุงุฎุชุจุฑ ุงููููุงุช ุงููุฎุชููุฉ:
   - ุฌุฑุจ ุฃูุซุฑ ูู ููุงุฉ ููุนุฑูุฉ ุงูุฃูุซุฑ ูุนุงููุฉ.

4. ุงุฎุชุฑ ุงููููุงุช ุงูุฃูุซุฑ ูุงุนููุฉ:
   - ุงุณุชุฎุฏู ุงููููุงุช ุงููุจุงุดุฑุฉ ูุซู ุงููุชุฌุฑ ุงูุฅููุชุฑููู.
   - ุฃู ุงููููุงุช ุบูุฑ ุงููุจุงุดุฑุฉ ูุซู ุงูุณูู ุงูุฅููุชุฑูููุฉ (ูุซู Amazon).

๐ก ูุซุงู ุนููู:
- ุดุฑูุฉ Glossier ุจุฏุฃุช ุจุงูุชุณููู ุนุจุฑ Instagram ูุงุณุชุฎุฏูุชู ูุจูุงุก ูุฌุชูุน ููู ูู ุงูุนููุงุก.
- ุดุฑูุฉ Apple ุชุนุชูุฏ ุนูู ุงููููุงุช ุงููุจุงุดุฑุฉ (ูุชุงุฌุฑูุง ุงูุฑุณููุฉ) ูุงูุฑูููุฉ (ูููุนูุง ุงูุฅููุชุฑููู)."""
    },
   #ููู ุฃุจูู ูููุฐุฌ ุนูู ูุงุฌุญ  ุ
{
    "ุงูุณุคุงู": "ููู ุฃุจูู ูููุฐุฌ ุนูู ูุงุฌุญ ",
    "ุงูุฅุฌุงุจุฉ": """๐ ูุจูุงุก ูููุฐุฌ ุนูู ูุงุฌุญ , ุงุชุจุน ุงูุฎุทูุงุช ุงูุชุงููุฉ:

1. ุงุจุฏุฃ ุจุชุญุฏูุฏ ุงููุดููุฉ:
   - ููู ุงููุดุงูู ุงูุชู ููุงุฌููุง ุนููุงุคู.
   - ูุฏู ุญููููุง ูุจุชูุฑุฉ ููุฐู ุงููุดุงูู.

2. ุญุฏุฏ ุงููููุฉ ุงูููุชุฑุญุฉ:
   - ููู ุชูุฏู ุดูุฆูุง ูุฑูุฏูุง ูุง ูุณุชุทูุน ุงูููุงูุณูู ุชูุฏูููุ

3. ุญุฏุฏ ุดุฑุงุฆุญ ุงูุนููุงุก:
   - ุฑูุฒ ุนูู ุดุฑูุญุฉ ูุงุญุฏุฉ ูู ุงูุจุฏุงูุฉ.
   - ูุฏู ุญููููุง ูุฎุตุตุฉ ููุฐู ุงูุดุฑูุญุฉ.

4. ุงุฎุชุฑ ุงููููุงุช ุงูููุงุณุจุฉ:
   - ุงุณุชุฎุฏู ุงููููุงุช ุงูุชู ูุตู ุจูุง ุฌูููุฑู ุงููุณุชูุฏู.
   - ุงุฎุชุจุฑ ุงููููุงุช ุงููุฎุชููุฉ ููุนุฑูุฉ ุงูุฃูุซุฑ ูุนุงููุฉ.

5. ุงุจูู ุนูุงูุงุช ูููุฉ:
   - ูุฏู ุฏุนููุง ููุชุงุฒูุง.
   - ุฃูุดุฆ ูุฌุชูุนุงุช ุชูุงุนููุฉ.

6. ุตูู ูููุฐุฌ ุงูุฅูุฑุงุฏุงุช:
   - ุงุฎุชุฑ ูููุฐุฌูุง ูุงูููุง ูุณุชุฏุงููุง (ูุซู ุงูุงุดุชุฑุงูุงุช ุฃู ุงููุจูุนุงุช ุงููุจุงุดุฑุฉ).

7. ุญุฏุฏ ุงูููุงุฑุฏ ูุงูุฃูุดุทุฉ ุงูุฑุฆูุณูุฉ:
   - ูุง ุงูุฐู ุชุญุชุงุฌู ูุชุดุบูู ูููุฐุฌ ุนูููุ
   - ูุง ุงูุนูููุงุช ุงูููููุฉ ุงูุฃุณุงุณูุฉุ

8. ุงุจุญุซ ุนู ุดุฑุงูุงุช ุงุณุชุฑุงุชูุฌูุฉ:
   - ุงุจุญุซ ุนู ุดุฑูุงุก ูุนุฒุฒูู ูููุฐุฌ ุนููู.

9. ุชุญูู ูู ุงูุชูุงููู:
   - ููู ุงููุฏุฑ ูุฒูุงุฏุฉ ุงูููุงุกุฉ.

๐ ูุตูุญุฉ ุฐูุจูุฉ:
ุฑูุฒ ุนูู ุชูุฏูู ูููุฉ ุญููููุฉ ููุนููุงุกุ ููู ูุฑููุง ูุชูููู ูููุฐุฌ ุนููู ุจูุงุกู ุนูู ุงูุชุบุฐูุฉ ุงูุฑุงุฌุนุฉ."""
}
]


# ========== ูุธุงู ุงูุจุญุซ ุงูุฐูู ุจุงุณุชุฎุฏุงู TF-IDF ู Cosine Similarity ========== #
def find_in_knowledge_base(user_query, language="ar"):
    user_query = user_query.strip().lower()
    questions = [entry["ุงูุณุคุงู"].strip().lower() for entry in bmc_knowledge_base]
    vectorizer = TfidfVectorizer()
    tfidf_matrix = vectorizer.fit_transform(questions + [user_query])
    similarity_scores = cosine_similarity(tfidf_matrix[-1], tfidf_matrix[:-1]).flatten()
    best_match_index = similarity_scores.argmax()
    highest_similarity = similarity_scores[best_match_index]
    if highest_similarity >= 0.4:  # ุถุจุท ุญุฏ ุงูุชุดุงุจู
        answer = bmc_knowledge_base[best_match_index]["ุงูุฅุฌุงุจุฉ"]
        return answer if language == "ar" else translate_to_english(answer)  # ุฏุนู ุงููุบุงุช ุงูุฃุฎุฑู
    return None

# ========== ุชุฑุฌูุฉ ุงููุตูุต ุฅูู ุงูุฅูุฌููุฒูุฉ ========== #
def translate_to_english(text):
    try:
        response = client.chat.completions.create(
            model="Meta-Llama-3.3-70B-Instruct",
            messages=[
                {"role": "system", "content": "Translate the following text to English."},
                {"role": "user", "content": text}
            ],
            temperature=0.7,
            max_tokens=1200,
            top_p=0.9
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        return f"โ๏ธ ุฎุทุฃ ูู ุงูุชุฑุฌูุฉ: {str(e)}"

# ========== ุฏุงูุฉ ุชุญููู ููู PDF ุจุงุณุชุฎุฏุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ========== #
def analyze_bmc(file):
    try:
        # ุงูุชุญูู ููุง ุฅุฐุง ูุงู ุงูููู ุนุจุงุฑุฉ ุนู ูุณุงุฑ ุฃู ุจูุงูุงุช ุซูุงุฆูุฉ
        if isinstance(file, str):  # ุฅุฐุง ูุงู ุงูููู ูุณุงุฑูุง
            if not os.path.exists(file):
                return "โ ุฎุทุฃ: ุงูููู ุบูุฑ ููุฌูุฏ."
            with open(file, "rb") as f:
                pdf_content = f.read()
        else:  # ุฅุฐุง ูุงู ุงูููู ุจูุงูุงุช ุซูุงุฆูุฉ ูุจุงุดุฑุฉ
            pdf_content = file.read()
        
        # ุชุญููู ุงูููู ุจุงุณุชุฎุฏุงู PyPDF2
        pdf_reader = PyPDF2.PdfReader(BytesIO(pdf_content))
        text = "\n".join([page.extract_text() or "" for page in pdf_reader.pages])
        
        # ุฅุฐุง ูู ูุชู ุงูุนุซูุฑ ุนูู ูุตูุต ูุจุงุดุฑุฉุ ุงุณุชุฎุฏุงู OCR
        if not text.strip():
            print("โ๏ธ ูุง ููุฌุฏ ูุต ูู ุงูููู... ุณูุชู ุงุณุชุฎุฏุงู OCR")
            images = convert_from_bytes(pdf_content)
            custom_config = r"--oem 3 --psm 6 -l ara"  # ุชุญุณูู OCR ููุบุฉ ุงูุนุฑุจูุฉ
            text = "\n".join([pytesseract.image_to_string(img, config=custom_config) for img in images])
        
        # ุฅุฐุง ูู ูุชู ุงุณุชุฎุฑุงุฌ ุฃู ูุต ุจุนุฏ ูู ุงููุญุงููุงุช
        if not text.strip():
            return "โ ุฎุทุฃ: ุงูููู ูุง ูุญุชูู ุนูู ูุตูุต ูุงุจูุฉ ููุงุณุชุฎุฑุงุฌ (ูุง ูุตูุต ุฃู OCR ูุดู)."
        
        # ุฅุฑุณุงู ุงููุต ุฅูู ูููุฐุฌ ุงูุฐูุงุก ุงูุงุตุทูุงุนู
        ai_response = generate_ai_response(
            message=f"ูู ุจุชูููู ูุฐุง ุงููููุฐุฌ ุจูุงุกู ุนูู ูุญุชูู ููู PDF ุงูุชุงูู: {text}",
            chat_history=[],
            instruction="""
๐ ูููุชู: ุชุญููู ูููุฐุฌ ุงูุนูู ูู ููู PDF ูุฅุนุงุฏุฉ ุงููุชุงุฆุฌ ุจุงูุชูุณูู ุงูุชุงูู:
1. ุชูููู ุณุฑูุน ููู ุนูุตุฑ ูู ุนูุงุตุฑ BMC ุงูุชุณุนุฉ:
   - ุงุณุชุฎุฏู ุงูุฑููุฒ: โ = ููุฌูุฏ ููุงุถุญ | โ๏ธ = ุจุญุงุฌุฉ ูุชุญุณูู | โ = ุบูุฑ ููุฌูุฏ.
   - ุฃุถู ููุงุญุธุฉ ูุฎุชุตุฑุฉ ููู ุนูุตุฑ.
   - ุงูุชุตุฑ ุนูู 3 ุณุทูุฑ ูุญุฏ ุฃูุตู ููู ุนูุตุฑ.
   ๐น ุงูุนูุงุตุฑ:
   - ุงููููุฉ ุงูููุชุฑุญุฉ
   - ุดุฑุงุฆุญ ุงูุนููุงุก
   - ูููุงุช ุงูุชูุฒูุน
   - ุงูุนูุงูุงุช ูุน ุงูุนููุงุก
   - ูุตุงุฏุฑ ุงูุฅูุฑุงุฏุงุช
   - ุงูููุงุฑุฏ ุงูุฑุฆูุณูุฉ
   - ุงูุฃูุดุทุฉ ุงูุฑุฆูุณูุฉ
   - ุงูุดุฑุงูุงุช ุงูุฑุฆูุณูุฉ
   - ูููู ุงูุชูุงููู
2. ุชุญููู ููุตู ููู ุนูุตุฑ:
   - ุฑูุฒ ุนูู ููุงุท ุงูููุฉ ูุงูุถุนู.
   - ุงุฐูุฑ ูุซุงููุง ุฃู ุณูุงููุง ูุงูุนููุง ูุชูุถูุญ ุงูุชุญููู.
   - ูุง ุชุณุชุฎุฏู ุฃูุซุฑ ูู 4 ุณุทูุฑ ููู ุนูุตุฑ.
3. ูุตุงุฆุญ ุชุญุณูููุฉ:
   - ุงูุชุฑุงุญ ุชุญุณูู ูุงุญุฏ  ุงู ุชุทูุจ ุฐูู ููุท ููู ุนูุตุฑ ุจุนูุงูุฉ โ๏ธ ุฃู โ.
   - ูุฌุจ ุฃู ุชููู ุงููุตุงุฆุญ ุนูููุฉ ููุงุจูุฉ ููุชุทุจูู.
4. ุชูุตูุงุช ุงุณุชุฑุงุชูุฌูุฉ ุดุงููุฉ:
   - ุงูุชุจ ููุฑุฉ ูุงุญุฏุฉ (3-4 ุณุทูุฑ) ุชุฌูุน ุจูู ุงูุชูุตูุงุช ุงูุฑุฆูุณูุฉ.
   - ุฑูุฒ ุนูู ููููุฉ ุชุญููู ุงูุชูุงุฒู ุจูู ุงููููุฉุ ุงูุชูุงูููุ ูุงูุนุงุฆุฏุงุช.
5. ููุงุญุธุงุช ุณุฑูุนุฉ:
   - ูุง ุชุถูู ุฃู ุชุญููู ุฎุงุฑุฌ ูุทุงู BMC.
   - ูุง ุชุณุชุฎุฏู ุฌุฏุงูู ุฃู ุชูุณููุงุช ูุนูุฏุฉ.
   - ูุง ุชุทูุจ ูุนูููุงุช ุฅุถุงููุฉ.
   - ูุง ุชุถูู ุชูุณูุฑุงุช ุทูููุฉ ููุฑููุฒ โ/โ๏ธ/โ.
๐ฏ ุงููุฏู: ุชูุฏูู ุชุญููู ูุญุชุฑู ูุณูู ุงููุฑุงุกุฉุ ูุน ุชูุซูู ุจุตุฑู ุฏููู.
""")
        return ai_response
    except Exception as e:
        return f"โ ุฎุทุฃ ูู ุงูุชุญููู: {str(e)}"
# ========== ุชูููุฏ ุฅุฌุงุจุฉ ุจุงุณุชุฎุฏุงู ุงููููุฐุฌ AI ========== #
def generate_ai_response(message, chat_history, instruction=None):
    try:
        system_instruction = """
๐ฏ ูููุชู ูู ุงูุนูู ููุณุชุดุงุฑ ุงุณุชุฑุงุชูุฌู ูุญุชุฑู ูุชุฎุตุต ูู Business Model Canvas (BMC)ุ ูุชุญููู ููุงุฐุฌ ุงูุฃุนูุงู ูุงูุงุณุชุฑุงุชูุฌูุงุช ุงููุฑุชุจุทุฉ ุจูุง.

๐ซ ูุง ุชุฌุจ ุนูู ุฃู ุงุณุชูุณุงุฑ ุฎุงุฑุฌ ูุทุงู ุชุฎุตุตู (BMCุ ุชุญููู ููุงุฐุฌ ุงูุฃุนูุงูุ ุงูุงุณุชุฑุงุชูุฌูุงุช ุงูุงูุชุตุงุฏูุฉุ ุชุญููู ุงูุดุฑูุงุช...). 
ุฅุฐุง ูุฑุฏ ุณุคุงู ุฎุงุฑุฌ ูุฐุง ุงููุทุงูุ ุงุณุชุฎุฏู ุงูุฑุฏ ุงูุชุงูู:
"ุนุฐุฑูุงุ ูุง ูููููู ุงูุฅุฌุงุจุฉ ุนูู ูุฐุง ุงูุณุคุงู ูุฃูู ุฎุงุฑุฌ ูุทุงู ุงุฎุชุตุงุตู."

โ ุนูุฏ ุงุณุชูุจุงู ุฃู ุณุคุงูุ ุงุชุจุน ุงูุชุนูููุงุช ุงูุชุงููุฉ ุจุฏูุฉ:
1. ุญุฏูุฏ ุงูุณูุงู ุจุฏูุฉ ูู ุฎูุงู ุงุณุชุฎุฑุงุฌ ุงููููุงุช ุงูููุชุงุญูุฉ ุงููุชุนููุฉ ุจูููุฐุฌ ุงูุนูู.
2. ุฅุฐุง ูุงู ุงูุณุคุงู ุบุงูุถูุง ุฃู ุบูุฑ ุฏูููุ ุฃุนุฏ ุตูุงุบุชู ุจุทุฑููุฉ ูุงุถุญุฉ ูููููุฉ ูุจู ุชูุฏูู ุงูุฑุฏ.
3. ูุฏูู ุฅุฌุงุจุฉ ูุฏุฑูุณุฉ ููุจููุฉ ุนูู ุฃูุถู ุงูููุงุฑุณุงุช ุงููุงูุนูุฉ ุฃู ุงูุฃุทุฑ ุงููุธุฑูุฉ ุงููุนุชูุฏุฉ ูู ููุงุฐุฌ ุงูุฃุนูุงู.
4. ุฅุฐุง ุทูุจ ุงููุณุชุฎุฏู "ุฃุนุฏ ุงูุดุฑุญ" ุฃู "ุงุดุฑุญูุง ูู"ุ ูุฃุนุฏ ุตูุงุบุฉ ุงูุฅุฌุงุจุฉ ุงูุณุงุจูุฉ ุจุทุฑููุฉ ูุจุณุทุฉ ูููุงุณุจุฉ ูููุณุชูู ุงูุนุงู.
5. ุฅุฐุง ุทูุจ ุงููุณุชุฎุฏู ุชุฑุฌูุฉ ุงูุฅุฌุงุจุฉ ุงูุณุงุจูุฉ  ุชุฑุฌููุง ุจุฏูุฉ ุ ูุน ุงูุญูุงุธ ุนูู ุงููุนูู ูุงูุงุญุชุฑุงููุฉ.
6. ุงุฌุจ ุจููุณ ุงููุบุฉ ุงูุชู ุชู ุทุฑุญ ุจูุง ุงูุณุคุงู 

๐ ุชุฐููุฑ: ุฃูุช ูุง ุชูุชูู ุจุงูุฅุฌุงุจุงุช ุงููุธุฑูุฉ ููุทุ ุจู ุชุณุนู ูุชูููู ุงููุณุชุฎุฏู ูู ููู ุงููููุฐุฌ ูุชุญูููู ูุชุทุจููู ุนููููุง.
"""
        if instruction:
            full_message = f"{instruction}\n\n{message}"
        else:
            full_message = message
            
        messages = [{"role": "system", "content": system_instruction}]
        for msg in chat_history:
            messages.append({"role": msg["role"], "content": msg["content"]})
        
        
        messages.append({"role": "user", "content": full_message})
        
        response = client.chat.completions.create(
            model="Meta-Llama-3.3-70B-Instruct",
            messages=messages,
            temperature=0.7,
            max_tokens=1200,
            top_p=0.9
        )
        bot_message = response.choices[0].message.content.strip()
        return bot_message
    except Exception as e:
        return f"โ๏ธ ุญุฏุซ ุฎุทุฃ ูู ุชูููุฏ ุงูุฅุฌุงุจุฉ: {str(e)}"

# ========== ุฅูุดุงุก ุชูุฑูุฑ ุจุตุฑู ููููุฐุฌ BMC ========== #
def create_bmc_visual_report(ai_response):
    # ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช ูู ุฑุฏ ุงูุฐูุงุก ุงูุงุตุทูุงุนู
    labels = []
    values = []
    colors = []

    for line in ai_response.split("\n"):
        if any(symbol in line for symbol in ["โ", "โ๏ธ", "โ"]):
            label, status = line.split(":")
            labels.append(label.strip())
            values.append(status.strip())
            if "โ" in line:
                colors.append("green")
            elif "โ๏ธ" in line:
                colors.append("orange")
            else:
                colors.append("red")

    fig = px.bar(
        x=labels,
        y=[1] * len(labels),  # ูููุฉ ุซุงุจุชุฉ ููู ูุณู
        color=values,
        title="๐ ุชูููู Business Model Canvas",
        labels={"x": "ุงูุฃูุณุงู", "y": "ุงูุญุงูุฉ"},
        color_discrete_map={
            "ููุฌูุฏ": "green",
            "ูุญุชูู ุนูู ูุนูููุงุช ุบูุฑ ูุงููุฉ": "orange",
            "ุบูุฑ ููุฌูุฏ": "red"
        }
    )
    return fig.to_html()

# ========== CSS ูุฎุตุต ูุชุญุณูู ุงููุงุฌูุฉ ========== #
custom_css = """
/* ุชุตููู ุนุงู */
body {
    background-color: #f9f9f9;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
.header {
    display: flex;
    align-items: center;
    gap: 25px;
    padding: 15px;
    background: linear-gradient(135deg, #ffffff, #e0f7fa);
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.header img {
    width: 80px;
    height: 80px;
    object-fit: contain;
}
.header h1 {
    margin: 0;
    color: #2d3436;
    font-size: 2rem;
}
.header p {
    margin: 0;
    color: #636e72;
    font-size: 1rem;
}
.bmc-section {
    background: #fff4e6 !important;
    border-radius: 15px !important;
    padding: 20px !important;
    margin-top: 20px !important;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.analysis-result {
    white-space: pre-wrap !important;
    font-family: monospace !important;
    background-color: #f9f9f9;
    padding: 15px;
    border-radius: 10px;
}
button.primary {
    background-color: #00bcd4;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}
button.primary:hover {
    background-color: #0097a7;
}
.footer {
    text-align: center;
    padding: 15px;
    background-color: #2d3436;
    color: white;
    font-size: 0.9rem;
    border-radius: 10px;
    margin-top: 20px;
}
@media (max-width: 768px) {
    .header {
        flex-direction: column;
        padding: 10px;
    }
    .header img {
        width: 60px;
        height: 60px;
    }
    .header h1 {
        font-size: 1.5rem;
    }
    .header p {
        font-size: 0.9rem;
    }
    .chat-container {
        height: 400px !important;
    }
    button.primary {
        font-size: 0.9rem;
    }
}
@media (max-width: 480px) {
    .header h1 {
        font-size: 1.2rem;
    }
    .header p {
        font-size: 0.8rem;
    }
    .chat-container {
        height: 300px !important;
    }
}
"""

# ========== ูุงุฌูุฉ ุงููุณุชุฎุฏู ุงููุญุณูุฉ ========== #
LOGO_PATH = "F:/BMC MonitorAI.jpg"  # ุชุฃูุฏ ูู ุตุญุฉ ุงููุณุงุฑ
if not os.path.exists(LOGO_PATH):
    raise FileNotFoundError(f"ููู ุงูุดุนุงุฑ ุบูุฑ ููุฌูุฏ: {LOGO_PATH}")
encoded_logo = base64.b64encode(open(LOGO_PATH, "rb").read()).decode("utf-8")

# ุฑุณุงูุฉ ุงูุชุฑุญูุจ ุงูุชููุงุฆูุฉ
WELCOME_MESSAGE = """
โจ๐ฅBMC MonitorAI ูุฑุญุจูุง ุจู ูู ุนุงูู๐ฅโจ
๐ุงูุฃููุงุฑ ุชููุฏ ููุง๐ญ ูุงูุฅุจุฏุงุน ูุง ูุนุฑู ุญุฏูุฏูุง๐ง ูุงููุฌุงุญ ูุจุฏุฃ ุจู ุงูุขู๐ก
๐ ุงุณุฃูุ ุดุงุฑู ูููุงุชูุ ูุงุจุฏุฃ ุฑุญูุชูโจ   
"""

with gr.Blocks(css=custom_css, theme=gr.themes.Soft(), title="BMC MonitorAI") as demo:
    # ------ ุดุฑูุท ุงูุนููุงู ุงููุญุณู ------ #
    gr.HTML(f"""
    <div class="header">
        <img src="data:image/png;base64,{encoded_logo}" style="width: 80px; height: 80px; object-fit: contain;">
        <div>
            <h1>BMC MonitorAI</h1>
            <p>ุงููุณุชุดุงุฑ ุงูุงุณุชุฑุงุชูุฌู ุงูุฐูู ูููุงุฐุฌ ุงูุฃุนูุงู</p>
        </div>
    </div>
    """)

    
    # ------ ููุทูุฉ ุงูุฏุฑุฏุดุฉ ุงููุญุณูุฉ ------ #
    chatbot = gr.Chatbot(
        avatar_images=(None, LOGO_PATH),
        elem_classes="chat-container",
        show_label=False,
        height=600,
        value=[(None, WELCOME_MESSAGE)]  # ุฅุถุงูุฉ ุงูุฑุณุงูุฉ ุงูุชุฑุญูุจูุฉ ููุง
    )

    # ------ ุนูุงุตุฑ ุงูุชุญูู ุงูุฐููุฉ ------ #
    with gr.Row():
        msg = gr.Textbox(
            placeholder="๐ก...ููุชุญููู PDF ุงูุชุจ ุณุคุงูู ุฃู ุงุฑูุน ููู",
            label=" ",
            scale=8,
            container=False,
            autofocus=True
        )
        submit_btn = gr.Button("ุฅุฑุณุงู ๐", variant="primary", scale=2)
        clear_btn = gr.Button("ูุณุญ ๐", variant="secondary")

    # ------ ูุณู ุชุญููู BMC ------ #
    with gr.Accordion("๐  (PDF)BMC ุชุญููู ููู ", open=False):
        gr.Markdown("""
        ุชุนูููุงุช ุงูุงุณุชุฎุฏุงู:
        1. ุงุฑูุน ููู PDF ูุญุชูู ุนูู ูููุฐุฌ ุนููู.
        2. ุงูุชุธุฑ ุชุญููู ุงููููุฐุฌ .
        3. ุงูุฑุฃ ุงูุชูููู ูุงููุตุงุฆุญ ุงูุชุญุณูููุฉ.
        """)
        bmc_upload = gr.File(label="๐ค ุฑูุน ุงูููู", file_types=[".pdf"])
        bmc_output = gr.Textbox(label="ูุชุงุฆุฌ ุงูุชุญููู", elem_classes="analysis-result")
        bmc_visual_report = gr.HTML(label="ุงูุชูุฑูุฑ ุงูุจุตุฑู")

    # ------ ุงูุฃุณุฆูุฉ ุงููุณุจูุฉ ------ #
    gr.Examples(
        examples=[
            "ุงูุชุณุนุฉุ BMCูุงูู ุนูุงุตุฑ",
            "ููู ุงุญุฏุฏ ุดุฑุงุฆุญ ุงูุนููุงุกุ",
            "ุงุนุทูู ูุซุงูุง ุนูู ูููุฐุฌ ุงูุฑุงุฏุงุช ูุจุชูุฑ"
        ],
        inputs=msg,
        label="๐ผ ุงุณุฆูุฉ ุงุณุชุฑุงุชูุฌูุฉ ูุณุจูุฉ"
    )

    # ------ ุชุฐููู ุงูุตูุญุฉ ------ #
    gr.Markdown("""
    <div class="footer">
        โก๏ธูุฏุนู ุชุญููู 9 ููููุงุช ุฃุณุงุณูุฉ<br>
         2025 BMC MonitorAI - ุฌููุน ุงูุญููู ูุญููุธุฉ
    </div>
    """)

    # ------ ุงูููุทู ุงูุชุดุบููู ------
    chat_history = gr.State([])

    def respond(message, chat_history):
        # ุงูุจุญุซ ุนู ุงูุฅุฌุงุจุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        kb_answer = find_in_knowledge_base(message)
        
        if kb_answer:  # ุฅุฐุง ุชู ุงูุนุซูุฑ ุนูู ุฅุฌุงุจุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
            bot_message = kb_answer.strip()
        else:  # ุงุณุชุฎุฏุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู
            bot_message = generate_ai_response(message, chat_history).strip()
            
        # ุชุญุฏูุซ ุณุฌู ุงูุฏุฑุฏุดุฉ
        chat_history.append({"role": "user", "content": message})
        chat_history.append({"role": "assistant", "content": bot_message})
        
        # ุชุญููู ุงูุณุฌู ุฅูู ุชูุณูู ุงูุนุฑุถ
        chat_messages = [
            (msg["content"], None) if msg["role"] == "user" else (None, msg["content"])
            for msg in chat_history
        ]
        return "", chat_messages, chat_history

    msg.submit(respond, [msg, chat_history], [msg, chatbot, chat_history])
    submit_btn.click(respond, [msg, chat_history], [msg, chatbot, chat_history])
    clear_btn.click(lambda: ([], []), [], [chatbot, chat_history])

    # ------ ุชุญููู ููู BMC ------ #
    def analyze_bmc_ui(file):
        if file is None:
            return "โ ุฎุทุฃ: ูู ูุชู ุชุญููู ุฃู ููู.", ""
        if not file.name.endswith(".pdf"):
            return "โ ุฎุทุฃ: ุงูููู ุงููุฑููุน ููุณ ุจุตูุบุฉ PDF.", ""
        # ุชุญููู ุงูููู
        analysis = analyze_bmc(file)
        # ุฅูุดุงุก ุชูุฑูุฑ ุจุตุฑู
        visual_report = create_bmc_visual_report(analysis)
        return analysis, visual_report

    bmc_upload.upload(analyze_bmc_ui, [bmc_upload], [bmc_output, bmc_visual_report])

# ========== ุชุดุบูู ุงูุชุทุจูู ========== #
if __name__ == "__main__":
    demo.launch(
        share=True,
        favicon_path=LOGO_PATH if os.path.exists(LOGO_PATH) else None
    )